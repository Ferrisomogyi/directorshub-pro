<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DirectorsHub Pro v2</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *{font-family:'Inter',sans-serif;box-sizing:border-box}
    body{background:#0a0a0f;color:#fff;margin:0;min-height:100vh}
    .glass{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:16px}
    .btn{padding:12px 24px;border-radius:12px;font-weight:600;cursor:pointer;transition:all 0.2s;border:none}
    .btn-red{background:linear-gradient(135deg,#dc2626,#b91c1c);color:#fff}
    .btn-purple{background:linear-gradient(135deg,#8b5cf6,#6d28d9);color:#fff}
    .btn-ghost{background:rgba(255,255,255,0.05);color:#fff;border:1px solid rgba(255,255,255,0.1)}
    .input{background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.1);color:#fff;padding:12px 16px;border-radius:12px;width:100%}
    .input:focus{outline:none;border-color:#dc2626}
    .tab{padding:12px 20px;border-radius:10px;cursor:pointer;transition:all 0.2s;color:rgba(255,255,255,0.6)}
    .tab:hover{background:rgba(255,255,255,0.05)}
    .tab.active{background:rgba(220,38,38,0.2);color:#fff;border-left:3px solid #dc2626}
    .card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:20px;padding:24px}
    .method-card{transition:all 0.3s;cursor:pointer}
    .method-card:hover{transform:translateY(-4px);border-color:rgba(220,38,38,0.5)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:100;padding:20px}
    .modal-content{background:#1a1a2e;border:1px solid rgba(255,255,255,0.1);border-radius:24px;padding:32px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto}
  </style>
</head>
<body>
<div id="app"></div>
<script>
const S={
  tab:'dashboard',apiKey:localStorage.getItem('directorshub_api')||'',project:null,scenes:[],selectedScene:null,
  actingNotes:[],chatMessages:[],isThinking:false,method:'stanislavski',
  showSettings:false,showNewProject:false,showMethod:null,showDirector:null,
  setElements:[],setImage:null,cameraLines:[],drawMode:null
};

const M={
  stanislavski:{n:'Stanislavski',i:'ğŸ­',c:'Klassiek',f:'K. Stanislavski',d:'Magic If, emotionele waarheid',t:['Magic If','Objectives'],q:['Wat wil je?']},
  method:{n:'Method Acting',i:'ğŸ”¥',c:'Klassiek',f:'Lee Strasberg',d:'Emotionele onderdompeling',t:['Affective Memory'],q:['Welke ervaring past?']},
  meisner:{n:'Meisner',i:'ğŸ”„',c:'Klassiek',f:'Sanford Meisner',d:'Living truthfully, luisteren',t:['Repetition'],q:['Luister je?']},
  chekhov:{n:'Chekhov',i:'ğŸŒŠ',c:'Klassiek',f:'Michael Chekhov',d:'Psychological Gesture',t:['PG','Atmosphere'],q:['Welk gebaar?']},
  adler:{n:'Stella Adler',i:'âœ¨',c:'Klassiek',f:'Stella Adler',d:'Verbeelding boven ervaring',t:['Script Analysis'],q:['Wat kun je voorstellen?']},
  practical:{n:'Practical Aesthetics',i:'ğŸ¯',c:'Modern',f:'David Mamet',d:'Letterlijk, Want, As If',t:['Essential Action'],q:['Wat doe je letterlijk?']},
  viewpoints:{n:'Viewpoints',i:'ğŸ‘ï¸',c:'Fysiek',f:'Anne Bogart',d:'Ruimte en beweging',t:['Spatial Relationship'],q:['Relatie tot ruimte?']},
  filmacting:{n:'Film Acting',i:'ğŸ“¹',c:'Camera',f:'Various',d:'Minimalisme',t:['Less is More'],q:['Kleiner maken?']},
  soapacting:{n:'Soap Acting',i:'ğŸ“º',c:'TV',f:'Various',d:'Snelheid, beschikbaarheid',t:['Quick Prep'],q:['Snel emotie?']},
  brecht:{n:'Brecht',i:'ğŸ”',c:'Politiek',f:'Bertolt Brecht',d:'Vervreemding',t:['Verfremdung'],q:['Toon je theater?']}
};

const D=[
  {n:'Spielberg',f:'ğŸ‡ºğŸ‡¸',t:'Close-up van verwondering',c:'Emotie',m:'E.T., Jaws'},
  {n:'Scorsese',f:'ğŸ‡ºğŸ‡¸',t:'Freeze frames, muziek als personage',c:'Karakter',m:'Goodfellas'},
  {n:'Fincher',f:'ğŸ‡ºğŸ‡¸',t:'40+ takes voor perfectie',c:'Precisie',m:'Fight Club'},
  {n:'Tarantino',f:'ğŸ‡ºğŸ‡¸',t:'Dialoog IS actie',c:'Dialoog',m:'Pulp Fiction'},
  {n:'Nolan',f:'ğŸ‡¬ğŸ‡§',t:'Tijdsmanipulatie',c:'Concept',m:'Inception'},
  {n:'Villeneuve',f:'ğŸ‡¨ğŸ‡¦',t:'Stilte is krachtig',c:'Sfeer',m:'Dune'},
  {n:'Kubrick',f:'ğŸ‡ºğŸ‡¸',t:'Symmetrie, 100+ takes',c:'Visueel',m:'The Shining'},
  {n:'Hitchcock',f:'ğŸ‡¬ğŸ‡§',t:'Suspense â‰  Surprise',c:'Suspense',m:'Psycho'},
  {n:'Kurosawa',f:'ğŸ‡¯ğŸ‡µ',t:'Weer als personage',c:'Episch',m:'Seven Samurai'},
  {n:'Bong',f:'ğŸ‡°ğŸ‡·',t:'Genre-mixing',c:'Satire',m:'Parasite'}
];

const id=()=>Math.random().toString(36).substr(2,9);
const save=()=>localStorage.setItem('directorshub_api',S.apiKey);

const ai=async(p,c='')=>{
  if(!S.apiKey)return'Voeg API key toe via âš™ï¸';
  try{
    const r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':S.apiKey,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:4096,system:'Je bent een ervaren regisseur. Nederlands.',messages:[{role:'user',content:c?c+'\n\n'+p:p}]})});
    const d=await r.json();return d.content?.[0]?.text||'Geen antwoord';
  }catch(e){return'Fout: '+e.message}
};

const parse=txt=>{
  const sc=[],lines=txt.split('\n');let cur=null,num=0;
  lines.forEach(l=>{const t=l.trim();if(/^(INT\.|EXT\.)/.test(t)){if(cur)sc.push(cur);num++;cur={id:id(),num,h:t,loc:t.replace(/^(INT\.|EXT\.)\s*/,'').split('-')[0],chars:new Set(),lines:[]};}else if(cur&&t){cur.lines.push(t);const m=t.match(/^([A-Z]{2,})/);if(m&&t.length<25)cur.chars.add(m[1]);}});
  if(cur)sc.push(cur);sc.forEach(s=>{s.chars=[...s.chars];s.txt=s.lines.join('\n')});return sc;
};

const render=()=>{
  document.getElementById('app').innerHTML=`
    <div style="display:flex;min-height:100vh">
      <nav style="width:200px;background:rgba(255,255,255,0.02);border-right:1px solid rgba(255,255,255,0.05);padding:16px;flex-shrink:0">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:24px">
          <div style="width:36px;height:36px;background:linear-gradient(135deg,#dc2626,#991b1b);border-radius:10px;display:flex;align-items:center;justify-content:center">ğŸ¬</div>
          <div><div style="font-weight:700;font-size:14px">DirectorsHub</div><div style="font-size:11px;opacity:0.5">Pro v2</div></div>
        </div>
        <div style="display:flex;flex-direction:column;gap:4px">
          ${['dashboard|ğŸ“Š|Dashboard','scripts|ğŸ“œ|Scripts','acting|ğŸ­|Acting','methods|ğŸ“š|Methodes','directors|ğŸ¬|Regisseurs','setplan|ğŸ—ºï¸|Set Plan','chat|ğŸ’¬|Chat'].map(x=>{const[k,i,l]=x.split('|');return'<div class="tab '+(S.tab===k?'active':'')+'" onclick="S.tab=\''+k+'\';render()">'+i+' '+l+'</div>';}).join('')}
        </div>
      </nav>
      <main style="flex:1;padding:24px;overflow-y:auto">
        <div style="display:flex;justify-content:flex-end;gap:10px;margin-bottom:16px">
          ${S.apiKey?'<span style="font-size:12px;color:#22c55e">ğŸŸ¢ AI</span>':'<span style="font-size:12px;color:#ef4444">ğŸ”´ API</span>'}
          <button class="btn btn-ghost" style="padding:8px 16px" onclick="S.showNewProject=true;render()">â•</button>
          <button class="btn btn-ghost" style="padding:8px 16px" onclick="S.showSettings=true;render()">âš™ï¸</button>
        </div>
        ${renderTab()}
      </main>
    </div>
    ${S.showSettings?renderSettings():''}
    ${S.showNewProject?renderNewProject():''}
    ${S.showMethod?renderMethodModal():''}
    ${S.showDirector!==null?renderDirectorModal():''}
  `;
  if(S.tab==='setplan')setTimeout(initCanvas,50);
};

const renderTab=()=>{
  if(S.tab==='dashboard')return renderDash();
  if(S.tab==='scripts')return renderScripts();
  if(S.tab==='acting')return renderActing();
  if(S.tab==='methods')return renderMethods();
  if(S.tab==='directors')return renderDirs();
  if(S.tab==='setplan')return renderSet();
  if(S.tab==='chat')return renderChat();
  return'';
};

const renderDash=()=>!S.project?`
  <div class="card" style="max-width:700px;margin:40px auto;text-align:center;background:linear-gradient(135deg,#1a1a2e,#16213e)">
    <div style="font-size:64px;margin-bottom:16px">ğŸ¬</div>
    <h1 style="margin:0 0 8px">DirectorsHub Pro</h1>
    <p style="opacity:0.6;margin-bottom:24px">${Object.keys(M).length} methodes â€¢ ${D.length} regisseurs â€¢ Set Planning</p>
    <div style="display:flex;gap:12px;justify-content:center">
      <button class="btn btn-red" onclick="S.showNewProject=true;render()">ğŸ¬ Start</button>
      <button class="btn btn-ghost" onclick="S.tab='methods';render()">ğŸ“š Methodes</button>
      <button class="btn btn-ghost" onclick="S.tab='setplan';render()">ğŸ—ºï¸ Set Plan</button>
    </div>
  </div>
`:`<h1>${S.project.name}</h1><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-top:20px">
  <div class="card"><div style="font-size:24px">ğŸ“œ</div><div style="font-size:28px;font-weight:700">${S.scenes.length}</div><div style="opacity:0.5">Scenes</div></div>
  <div class="card"><div style="font-size:24px">ğŸ‘¥</div><div style="font-size:28px;font-weight:700">${[...new Set(S.scenes.flatMap(s=>s.chars))].length}</div><div style="opacity:0.5">Karakters</div></div>
  <div class="card"><div style="font-size:24px">ğŸ—ºï¸</div><div style="font-size:28px;font-weight:700">${S.setElements.length}</div><div style="opacity:0.5">Set Elements</div></div>
  <div class="card"><div style="font-size:24px">ğŸ­</div><div style="font-size:28px;font-weight:700">${Object.keys(M).length}</div><div style="opacity:0.5">Methodes</div></div>
</div>`;

const renderScripts=()=>`
  <div style="display:flex;justify-content:space-between;margin-bottom:16px"><h1 style="margin:0">Scripts</h1>
    <div style="display:flex;gap:8px"><button class="btn btn-red" onclick="document.getElementById('fIn').click()">ğŸ“¤ Upload</button><input type="file" id="fIn" style="display:none" accept=".txt,.docx" onchange="handleFile(event)"></div>
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
    <div class="card"><h3 style="margin:0 0 12px">Upload</h3>
      <div style="border:2px dashed rgba(255,255,255,0.1);padding:32px;text-align:center;border-radius:12px;cursor:pointer" onclick="document.getElementById('fIn').click()">ğŸ“„ Klik om te uploaden</div>
      <textarea id="scriptTxt" class="input" style="height:80px;margin-top:12px;resize:none" placeholder="Of plak tekst..."></textarea>
      <button class="btn btn-ghost" style="width:100%;margin-top:8px" onclick="parseTxt()">Analyseer</button>
    </div>
    <div class="card"><h3 style="margin:0 0 12px">Scenes (${S.scenes.length})</h3>
      <div style="max-height:300px;overflow-y:auto">${S.scenes.map(s=>`<div style="padding:10px;background:rgba(255,255,255,0.03);border-radius:10px;margin-bottom:6px;cursor:pointer;border:1px solid ${S.selectedScene?.id===s.id?'#dc2626':'transparent'}" onclick="S.selectedScene=S.scenes.find(x=>x.id==='${s.id}');render()"><strong style="color:#ef4444">${s.num}</strong> ${s.loc}</div>`).join('')||'<p style="opacity:0.5;text-align:center">Geen script</p>'}</div>
    </div>
  </div>
`;

const renderActing=()=>`
  <h1 style="margin:0 0 16px">Acteeraanwijzingen</h1>
  <div style="display:grid;grid-template-columns:250px 1fr;gap:16px">
    <div class="card"><h4 style="margin:0 0 12px">Methode: ${M[S.method].n}</h4>
      <div style="max-height:200px;overflow-y:auto">${Object.entries(M).map(([k,m])=>`<div style="padding:8px;background:${S.method===k?'rgba(220,38,38,0.2)':'rgba(255,255,255,0.03)'};border-radius:8px;margin-bottom:4px;cursor:pointer;font-size:13px" onclick="S.method='${k}';render()">${m.i} ${m.n}</div>`).join('')}</div>
    </div>
    <div class="card"><h3 style="margin:0 0 16px">Genereer</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
        <select id="aScene" class="input"><option value="">Scene...</option>${S.scenes.map(s=>`<option value="${s.id}">${s.num}</option>`).join('')}</select>
        <select id="aChar" class="input"><option value="">Karakter...</option>${[...new Set(S.scenes.flatMap(s=>s.chars))].map(c=>`<option value="${c}">${c}</option>`).join('')}</select>
      </div>
      <button class="btn btn-purple" style="width:100%" onclick="genActing()">ğŸ¤– Genereer</button>
      <div style="margin-top:16px">${S.actingNotes.slice(-2).map(n=>`<div style="background:rgba(255,255,255,0.03);padding:12px;border-radius:10px;margin-bottom:8px;font-size:13px"><strong>${n.char}</strong> - ${n.method}<br><div style="opacity:0.7;margin-top:8px;white-space:pre-wrap">${n.content}</div></div>`).join('')||'<p style="opacity:0.5">Selecteer scene & karakter</p>'}</div>
    </div>
  </div>
`;

const renderMethods=()=>`
  <h1 style="margin:0 0 16px">${Object.keys(M).length} Methodes</h1>
  <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px">
    ${Object.entries(M).map(([k,m])=>`<div class="card method-card" onclick="S.showMethod='${k}';render()"><div style="font-size:24px;margin-bottom:8px">${m.i}</div><div style="font-weight:600">${m.n}</div><div style="font-size:11px;opacity:0.5">${m.f}</div></div>`).join('')}
  </div>
`;

const renderMethodModal=()=>{const m=M[S.showMethod];return m?`<div class="modal" onclick="S.showMethod=null;render()"><div class="modal-content" onclick="event.stopPropagation()"><div style="display:flex;justify-content:space-between;margin-bottom:16px"><div style="display:flex;gap:12px;align-items:center"><span style="font-size:40px">${m.i}</span><div><h2 style="margin:0">${m.n}</h2><p style="opacity:0.5;margin:4px 0 0">${m.f}</p></div></div><button class="btn btn-ghost" onclick="S.showMethod=null;render()">âœ•</button></div><p>${m.d}</p><div style="background:rgba(255,255,255,0.05);padding:12px;border-radius:10px;margin:12px 0"><strong>Technieken:</strong> ${m.t.join(', ')}</div><button class="btn btn-red" style="width:100%" onclick="S.method='${S.showMethod}';S.showMethod=null;S.tab='acting';render()">ğŸ­ Gebruik</button></div></div>`:''};

const renderDirs=()=>`
  <h1 style="margin:0 0 16px">${D.length} Regisseurs</h1>
  <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px">
    ${D.map((d,i)=>`<div class="card method-card" onclick="S.showDirector=${i};render()"><div style="display:flex;gap:10px;align-items:center;margin-bottom:8px"><span style="font-size:24px">${d.f}</span><div><div style="font-weight:600">${d.n}</div><div style="font-size:11px;opacity:0.5">${d.c}</div></div></div><p style="font-size:13px;opacity:0.6;margin:0">"${d.t}"</p></div>`).join('')}
  </div>
`;

const renderDirectorModal=()=>{const d=D[S.showDirector];return d?`<div class="modal" onclick="S.showDirector=null;render()"><div class="modal-content" onclick="event.stopPropagation()"><div style="display:flex;justify-content:space-between;margin-bottom:16px"><div style="display:flex;gap:12px;align-items:center"><span style="font-size:40px">${d.f}</span><h2 style="margin:0">${d.n}</h2></div><button class="btn btn-ghost" onclick="S.showDirector=null;render()">âœ•</button></div><div style="background:rgba(245,158,11,0.1);padding:16px;border-radius:12px;margin-bottom:12px"><strong style="color:#f59e0b">ğŸ’¡ Tip</strong><p style="margin:8px 0 0;font-size:16px">"${d.t}"</p></div><p><strong>Films:</strong> ${d.m}</p><button class="btn btn-purple" style="width:100%" onclick="deepDir('${d.n}')">ğŸ¤– Meer</button></div></div>`:''};

const renderSet=()=>`
  <div style="display:flex;justify-content:space-between;margin-bottom:16px">
    <h1 style="margin:0">Set Planning</h1>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost" onclick="document.getElementById('setImg').click()">ğŸ–¼ï¸ Plattegrond</button>
      <button class="btn btn-ghost" onclick="clearSet()">ğŸ—‘ï¸</button>
      <button class="btn btn-purple" onclick="aiBlocking()">ğŸ¤– Tips</button>
    </div>
    <input type="file" id="setImg" style="display:none" accept="image/*" onchange="loadImg(event)">
  </div>
  <div style="display:grid;grid-template-columns:180px 1fr;gap:16px">
    <div>
      <div class="card" style="margin-bottom:12px">
        <h4 style="margin:0 0 12px">Elementen</h4>
        ${['actor|ğŸ‘¤|#ef4444|Actor','camera|ğŸ“¹|#3b82f6|Camera','light|ğŸ’¡|#eab308|Licht','prop|ğŸª‘|#22c55e|Prop','mark|âœ–ï¸|#a855f7|Mark'].map(x=>{const[t,i,c,l]=x.split('|');return'<button class="btn btn-ghost" style="width:100%;margin-bottom:6px;justify-content:flex-start;display:flex;align-items:center;gap:8px;padding:10px" onclick="addEl(\''+t+'\')"><span style="width:20px;height:20px;background:'+c+';border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px">'+i+'</span>'+l+'</button>';}).join('')}
      </div>
      <div class="card" style="margin-bottom:12px">
        <h4 style="margin:0 0 12px">Tekenen</h4>
        <button class="btn ${S.drawMode==='line'?'btn-red':'btn-ghost'}" style="width:100%;margin-bottom:6px" onclick="setDraw('line')">ğŸ“ Kijklijn</button>
        <button class="btn ${S.drawMode==='move'?'btn-red':'btn-ghost'}" style="width:100%;margin-bottom:6px" onclick="setDraw('move')">â¡ï¸ Beweging</button>
        <button class="btn btn-ghost" style="width:100%" onclick="undoLine()">â†©ï¸ Undo</button>
      </div>
      <div class="card">
        <h4 style="margin:0 0 12px">Patterns</h4>
        ${['triangle|ğŸ”º|Driehoek','diagonal|â†—ï¸|Diagonaal','ots|ğŸ¬|OTS Setup'].map(x=>{const[p,i,l]=x.split('|');return'<div style="padding:8px;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:6px;cursor:pointer;font-size:13px" onclick="pattern(\''+p+'\')">'+i+' '+l+'</div>';}).join('')}
      </div>
    </div>
    <div class="card" style="padding:0;overflow:hidden">
      <canvas id="setCanvas" width="800" height="500" style="display:block;width:100%;cursor:crosshair;background:#1a1a2e"></canvas>
      <div style="padding:10px;font-size:12px;opacity:0.6">${S.setElements.length} elementen â€¢ ${S.cameraLines.length} lijnen ${S.drawMode?'â€¢ <span style="color:#ef4444">'+S.drawMode+'</span>':''}</div>
    </div>
  </div>
  ${S.setElements.length?'<div class="card" style="margin-top:12px"><h4 style="margin:0 0 12px">Elementen</h4><div style="display:flex;flex-wrap:wrap;gap:8px">'+S.setElements.map((e,i)=>'<span style="padding:6px 12px;background:rgba(255,255,255,0.05);border-radius:20px;font-size:12px;display:flex;align-items:center;gap:6px"><span style="width:16px;height:16px;background:'+(e.type==='actor'?'#ef4444':e.type==='camera'?'#3b82f6':e.type==='light'?'#eab308':e.type==='prop'?'#22c55e':'#a855f7')+';border-radius:50%"></span>'+e.name+'<span style="cursor:pointer;opacity:0.5" onclick="remEl('+i+')">âœ•</span></span>').join('')+'</div></div>':''}
`;

const renderChat=()=>`
  <div style="display:flex;flex-direction:column;height:calc(100vh - 120px)">
    <h1 style="margin:0 0 16px">AI Chat</h1>
    <div class="card" style="flex:1;display:flex;flex-direction:column;overflow:hidden;padding:0">
      <div id="chatBox" style="flex:1;overflow-y:auto;padding:16px">
        ${S.chatMessages.length===0?'<div style="text-align:center;padding:40px"><div style="font-size:48px;margin-bottom:12px">ğŸ¬</div><h3>Vraag me alles!</h3><div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:16px">'+['Stanislavski?','Blocking tips?','Soap acting?'].map(q=>'<button class="btn btn-ghost" onclick="qChat(\''+q+'\')">'+q+'</button>').join('')+'</div></div>':S.chatMessages.map(m=>'<div style="display:flex;'+(m.role==='user'?'justify-content:flex-end':'')+'margin-bottom:12px"><div style="max-width:80%;padding:12px;border-radius:12px;'+(m.role==='user'?'background:rgba(220,38,38,0.2)':'background:rgba(139,92,246,0.1)')+'"><div style="white-space:pre-wrap;font-size:14px">'+m.content+'</div></div></div>').join('')+(S.isThinking?'<div style="opacity:0.5">ğŸ¤– Denken...</div>':'')}
      </div>
      <div style="padding:12px;border-top:1px solid rgba(255,255,255,0.1);display:flex;gap:8px">
        <input id="chatIn" class="input" style="flex:1" placeholder="Vraag..." onkeypress="if(event.key==='Enter')sendChat()">
        <button class="btn btn-purple" onclick="sendChat()">Send</button>
      </div>
    </div>
  </div>
`;

const renderSettings=()=>`<div class="modal" onclick="S.showSettings=false;render()"><div class="modal-content" onclick="event.stopPropagation()"><h2 style="margin:0 0 16px">Instellingen</h2><label>API Key</label><input class="input" type="password" placeholder="sk-ant-..." value="${S.apiKey}" onchange="S.apiKey=this.value;save();render()"><p style="font-size:12px;opacity:0.5;margin-top:8px">console.anthropic.com</p><div style="margin-top:16px;display:flex;flex-direction:column;gap:8px"><button class="btn btn-ghost" onclick="exportP()">ğŸ“¤ Export</button><button class="btn btn-ghost" onclick="importP()">ğŸ“¥ Import</button></div><button class="btn btn-ghost" style="width:100%;margin-top:16px" onclick="S.showSettings=false;render()">Sluiten</button></div></div>`;

const renderNewProject=()=>`<div class="modal" onclick="S.showNewProject=false;render()"><div class="modal-content" onclick="event.stopPropagation()"><h2 style="margin:0 0 16px">Nieuw Project</h2><input id="pName" class="input" placeholder="Naam..." style="margin-bottom:12px"><select id="pType" class="input"><option>Soap</option><option>Film</option><option>Serie</option></select><button class="btn btn-red" style="width:100%;margin-top:16px" onclick="createP()">Start</button></div></div>`;

// Handlers
window.handleFile=e=>{const f=e.target.files[0];if(!f)return;const ext=f.name.split('.').pop().toLowerCase();if(ext==='docx'){const reader=new FileReader();reader.onload=async ev=>{try{const r=await mammoth.extractRawText({arrayBuffer:ev.target.result});S.scenes=parse(r.value);if(S.scenes.length>0)S.selectedScene=S.scenes[0];render();}catch(err){alert('DOCX fout: '+err.message);}};reader.readAsArrayBuffer(f);}else{const reader=new FileReader();reader.onload=ev=>{S.scenes=parse(ev.target.result);if(S.scenes.length>0)S.selectedScene=S.scenes[0];render();};reader.readAsText(f);}e.target.value='';};
window.parseTxt=()=>{const t=document.getElementById('scriptTxt')?.value;if(t){S.scenes=parse(t);render();}};
window.genActing=async()=>{const sid=document.getElementById('aScene')?.value,ch=document.getElementById('aChar')?.value;if(!sid||!ch){alert('Selecteer beide');return;}const sc=S.scenes.find(s=>s.id===sid),m=M[S.method];S.isThinking=true;render();const r=await ai('Aanwijzingen voor '+ch+' in scene '+sc.num+' met '+m.n+': '+m.d+'\nTechnieken: '+m.t.join(', ')+'\nTekst: '+sc.txt);S.actingNotes.push({id:id(),char:ch,method:m.n,content:r});S.isThinking=false;render();};
window.deepDir=async n=>{S.isThinking=true;S.showDirector=null;S.tab='chat';render();const r=await ai('Analyse '+n+': stijl, camera, editing, lessen');S.chatMessages.push({role:'assistant',content:'ğŸ¬ '+n+':\n\n'+r});S.isThinking=false;render();};
window.sendChat=async()=>{const i=document.getElementById('chatIn'),m=i?.value?.trim();if(!m)return;S.chatMessages.push({role:'user',content:m});i.value='';S.isThinking=true;render();const r=await ai(m);S.chatMessages.push({role:'assistant',content:r});S.isThinking=false;render();setTimeout(()=>{const b=document.getElementById('chatBox');if(b)b.scrollTop=b.scrollHeight;},50);};
window.qChat=q=>{document.getElementById('chatIn').value=q;sendChat();};
window.createP=()=>{const n=document.getElementById('pName')?.value;if(!n){alert('Naam');return;}S.project={id:id(),name:n,type:document.getElementById('pType')?.value};S.showNewProject=false;render();};
window.exportP=()=>{const d={project:S.project,scenes:S.scenes,actingNotes:S.actingNotes,setElements:S.setElements,cameraLines:S.cameraLines,method:S.method};const b=new Blob([JSON.stringify(d)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='directorshub.json';a.click();};
window.importP=()=>{const i=document.createElement('input');i.type='file';i.accept='.json';i.onchange=async e=>{const d=JSON.parse(await e.target.files[0].text());Object.assign(S,d);S.showSettings=false;render();};i.click();};

// Set Planning
let ctx=null,drawing=false,start=null;
window.loadImg=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{S.setImage=ev.target.result;render();};r.readAsDataURL(f);};
window.initCanvas=()=>{const c=document.getElementById('setCanvas');if(!c)return;ctx=c.getContext('2d');redraw();
  c.onmousedown=e=>{if(!S.drawMode)return;const rect=c.getBoundingClientRect();start={x:(e.clientX-rect.left)*(c.width/rect.width),y:(e.clientY-rect.top)*(c.height/rect.height)};drawing=true;};
  c.onmousemove=e=>{if(!drawing||!start)return;const rect=c.getBoundingClientRect();const x=(e.clientX-rect.left)*(c.width/rect.width),y=(e.clientY-rect.top)*(c.height/rect.height);redraw();ctx.beginPath();ctx.moveTo(start.x,start.y);ctx.lineTo(x,y);ctx.strokeStyle=S.drawMode==='line'?'#3b82f6':'#22c55e';ctx.lineWidth=3;ctx.setLineDash(S.drawMode==='move'?[10,5]:[]);ctx.stroke();};
  c.onmouseup=e=>{if(!drawing||!start)return;const rect=c.getBoundingClientRect();const x=(e.clientX-rect.left)*(c.width/rect.width),y=(e.clientY-rect.top)*(c.height/rect.height);S.cameraLines.push({x1:start.x,y1:start.y,x2:x,y2:y,type:S.drawMode});drawing=false;start=null;redraw();render();};
};
window.redraw=()=>{const c=document.getElementById('setCanvas');if(!c||!ctx)return;ctx.clearRect(0,0,c.width,c.height);ctx.fillStyle='#1a1a2e';ctx.fillRect(0,0,c.width,c.height);
  if(S.setImage){const img=new Image();img.onload=()=>{const scale=Math.min(c.width/img.width,c.height/img.height)*0.9;const w=img.width*scale,h=img.height*scale;ctx.drawImage(img,(c.width-w)/2,(c.height-h)/2,w,h);drawEls();drawLines();};img.src=S.setImage;}else{drawEls();drawLines();}
};
window.drawEls=()=>{S.setElements.forEach(el=>{ctx.beginPath();ctx.arc(el.x,el.y,18,0,Math.PI*2);ctx.fillStyle=el.type==='actor'?'#ef4444':el.type==='camera'?'#3b82f6':el.type==='light'?'#eab308':el.type==='prop'?'#22c55e':'#a855f7';ctx.fill();ctx.fillStyle='#fff';ctx.font='11px Inter';ctx.textAlign='center';ctx.fillText(el.name,el.x,el.y+32);
  if(el.type==='camera'){ctx.beginPath();ctx.moveTo(el.x,el.y);const a=el.angle||0,l=80;ctx.lineTo(el.x+Math.cos(a-0.4)*l,el.y+Math.sin(a-0.4)*l);ctx.lineTo(el.x+Math.cos(a+0.4)*l,el.y+Math.sin(a+0.4)*l);ctx.closePath();ctx.fillStyle='rgba(59,130,246,0.15)';ctx.fill();}
});};
window.drawLines=()=>{S.cameraLines.forEach(l=>{ctx.beginPath();ctx.moveTo(l.x1,l.y1);ctx.lineTo(l.x2,l.y2);ctx.strokeStyle=l.type==='line'?'#3b82f6':'#22c55e';ctx.lineWidth=3;ctx.setLineDash(l.type==='move'?[10,5]:[]);ctx.stroke();ctx.setLineDash([]);
  const a=Math.atan2(l.y2-l.y1,l.x2-l.x1);ctx.beginPath();ctx.moveTo(l.x2,l.y2);ctx.lineTo(l.x2-12*Math.cos(a-0.5),l.y2-12*Math.sin(a-0.5));ctx.lineTo(l.x2-12*Math.cos(a+0.5),l.y2-12*Math.sin(a+0.5));ctx.fill();
});};
window.addEl=t=>{const n=prompt(t+' naam:');if(!n)return;const c=document.getElementById('setCanvas');S.setElements.push({id:id(),type:t,name:n,x:c?c.width/2+Math.random()*100-50:400,y:c?c.height/2+Math.random()*100-50:250,angle:t==='camera'?-Math.PI/2:0});render();};
window.remEl=i=>{S.setElements.splice(i,1);render();};
window.setDraw=m=>{S.drawMode=S.drawMode===m?null:m;render();};
window.undoLine=()=>{S.cameraLines.pop();render();};
window.clearSet=()=>{if(!confirm('Alles wissen?'))return;S.setElements=[];S.cameraLines=[];S.setImage=null;render();};
window.pattern=p=>{const cx=400,cy=250;
  if(p==='triangle'){S.setElements.push({id:id(),type:'actor',name:'A',x:cx,y:cy-60},{id:id(),type:'actor',name:'B',x:cx-80,y:cy+50},{id:id(),type:'actor',name:'C',x:cx+80,y:cy+50},{id:id(),type:'camera',name:'CAM',x:cx,y:cy+150,angle:-Math.PI/2});}
  else if(p==='diagonal'){S.setElements.push({id:id(),type:'actor',name:'A',x:cx-100,y:cy-60},{id:id(),type:'actor',name:'B',x:cx+100,y:cy+60},{id:id(),type:'camera',name:'CAM',x:cx+180,y:cy-120,angle:Math.PI*0.75});}
  else if(p==='ots'){S.setElements.push({id:id(),type:'actor',name:'A',x:cx-60,y:cy},{id:id(),type:'actor',name:'B',x:cx+60,y:cy},{id:id(),type:'camera',name:'OTS-A',x:cx+120,y:cy-80,angle:Math.PI*0.8},{id:id(),type:'camera',name:'OTS-B',x:cx-120,y:cy-80,angle:Math.PI*0.2});}
  render();
};
window.aiBlocking=async()=>{S.isThinking=true;S.tab='chat';render();const els=S.setElements.map(e=>e.type+':'+e.name).join(', ')||'geen';const r=await ai('Blocking tips voor: '+els+'. Geef CAMERA POSITIES, ACTOR BLOCKING, KIJKLIJNEN.');S.chatMessages.push({role:'assistant',content:'ğŸ—ºï¸ Blocking:\n\n'+r});S.isThinking=false;render();};

render();
</script>
</body>
</html>
